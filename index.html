<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo List</title>

    <!-- Bootstrap v5.3 -->
    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-5.3.7/package/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="/assets/vendor/bootstrap-icons-1.13.1/package/font/bootstrap-icons.min.css"
    />

    <style>
      .dragging {
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <div>
        <h1>Todo List</h1>
        <hr />

        <!-- Form -->
        <form id="formData">
          <div class="mb-3">
            <label for="text" class="form-label">
              Apa rencana kamu selanjutnya?
            </label>
            <div class="input-group flex-nowrap">
              <input type="text" class="form-control" name="todo" />
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-plus"></i> Tambah
              </button>
            </div>
          </div>
        </form>

        <!-- Filter & Search -->
        <div class="d-flex mb-3">
          <select id="filterStatus" class="form-select w-auto me-2">
            <option value="all">Semua</option>
            <option value="completed">Selesai</option>
            <option value="pending">Belum Selesai</option>
          </select>
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Cari todo..."
          />
        </div>

        <!-- Todo List -->
        <ul class="list-group" id="todoList"></ul>
      </div>
    </div>

    <script>
      let todos = [];
      let filterStatus = "all";
      let searchQuery = "";

      function saveTodos() {
        localStorage.setItem("todos", JSON.stringify(todos));
      }

      function renderTodos() {
        const todoList = document.getElementById("todoList");
        todoList.innerHTML = "";

        let filteredTodos = todos.filter((item) => {
          if (filterStatus === "completed") return item.completed;
          if (filterStatus === "pending") return !item.completed;
          return true;
        });

        if (searchQuery) {
          filteredTodos = filteredTodos.filter((item) =>
            item.todo.toLowerCase().includes(searchQuery.toLowerCase())
          );
        }

        filteredTodos.forEach((item, index) => {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex align-items-center justify-content-between";
          li.draggable = true;

          // Drag events
          li.addEventListener("dragstart", () => {
            li.classList.add("dragging");
          });
          li.addEventListener("dragend", () => {
            li.classList.remove("dragging");
            const items = [...todoList.children];
            todos = items.map((el) => todos[el.dataset.index]);
            saveTodos();
            renderTodos();
          });
          li.dataset.index = todos.indexOf(item);

          const div = document.createElement("div");
          div.className = "flex-fill";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "form-check-input me-1";
          checkbox.checked = item.completed;
          checkbox.addEventListener("change", () => {
            item.completed = checkbox.checked;
            saveTodos();
            renderTodos();
          });

          const label = document.createElement("label");
          label.className = "form-check-label";
          label.style.textDecoration = item.completed ? "line-through" : "none";
          label.textContent = item.todo;

          div.appendChild(checkbox);
          div.appendChild(label);

          const buttonGroup = document.createElement("div");

          // Edit button
          const editButton = document.createElement("button");
          editButton.className = "btn btn-sm btn-outline-warning me-1";
          editButton.innerHTML = '<i class="bi bi-pencil"></i>';
          editButton.addEventListener("click", () => {
            const newTodo = prompt("Ubah todo:", item.todo);
            if (newTodo && newTodo.trim() !== "") {
              if (
                todos.some(
                  (t) =>
                    t.todo.toLowerCase() === newTodo.toLowerCase() && t !== item
                )
              ) {
                alert("Todo dengan judul yang sama sudah ada!");
              } else {
                item.todo = newTodo.trim();
                saveTodos();
                renderTodos();
              }
            }
          });

          // Delete button
          const deleteButton = document.createElement("button");
          deleteButton.className = "btn btn-sm btn-outline-danger";
          deleteButton.innerHTML = '<i class="bi bi-trash"></i>';
          deleteButton.addEventListener("click", () => {
            todos.splice(todos.indexOf(item), 1);
            saveTodos();
            renderTodos();
          });

          buttonGroup.appendChild(editButton);
          buttonGroup.appendChild(deleteButton);

          li.appendChild(div);
          li.appendChild(buttonGroup);
          todoList.appendChild(li);
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("formData");
        const searchInput = document.getElementById("searchInput");
        const filterSelect = document.getElementById("filterStatus");
        const todoList = document.getElementById("todoList");

        // Muat todos dari localStorage
        const storedTodos = localStorage.getItem("todos");
        if (storedTodos) {
          todos = JSON.parse(storedTodos);
        }

        form.addEventListener("submit", function (event) {
          event.preventDefault();
          const todoInput = form.todo.value.trim();

          if (todoInput === "") {
            alert("Todo tidak boleh kosong!");
            return;
          }

          // Validasi duplikat
          if (
            todos.some((t) => t.todo.toLowerCase() === todoInput.toLowerCase())
          ) {
            alert("Todo dengan judul yang sama sudah ada!");
            return;
          }

          todos.unshift({
            todo: todoInput,
            completed: false,
          });

          form.todo.value = "";
          saveTodos();
          renderTodos();
        });

        // Filter
        filterSelect.addEventListener("change", function () {
          filterStatus = this.value;
          renderTodos();
        });

        // Search
        searchInput.addEventListener("input", function () {
          searchQuery = this.value;
          renderTodos();
        });

        // Drag & drop sorting
        todoList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const dragging = document.querySelector(".dragging");
          const afterElement = getDragAfterElement(todoList, e.clientY);
          if (afterElement == null) {
            todoList.appendChild(dragging);
          } else {
            todoList.insertBefore(dragging, afterElement);
          }
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        renderTodos();
      });
    </script>
  </body>
</html>
